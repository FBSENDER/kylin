%section.container
  %h1= @article.baike_name
  
  .row
    = form_tag('/article/edit_finish') do
      %input{name: 'article_id', id: 'article_id', class: 'hidden', value: "#{@article.id}"}
      %input{name: 'article_json', id: 'article_json', class: 'hidden'}
      %input{id: 'btn_submit', type: 'submit', name: 'commit', value: 'save', class: 'btn btn-default disabled'}
  %hr
  .row#add
    %button#btn_add_h2.btn.btn-default 增加二级标题
    %button#btn_add_h3.btn.btn-default 增加三级标题
    %button#btn_add_p.btn.btn-default 增加段落
    %button#btn_add_img.btn.btn-default 增加图片
    %button#btn_save.btn.btn-default 保存
    %button#upload_img.btn.btn-default 上传图片
  %hr
  .row
    #preview.col-md-6
    #operation.col-md-6

  

%script{type: 'text/javascript'}
  $(document).ready(function(){
  h2_index = 0;
  h3_index = 0;
  p_index = 0;
  img_index = 0;
  $('#btn_add_h2').click(function(){
  $('#preview').append('<div><h2 id='+ '"h2_pre_' + h2_index +'"' + '>二级标题</h2></div>');
  $('#operation').append('<div><input type="text" id="h2_op_' + h2_index +'" placeholder="请输入二级标题" class="h2" data-id="'+ h2_index +'" data-mktype="h2" onchange="txt_change(this);"> <button class="btn btn-defalut" onclick="remove_item(this);" data-id="'+ h2_index +'" data-mktype="h2" id="h2_btn_' + h2_index +'">删除该节点</button></div>');
  h2_index += 1;
  });
  $('#btn_add_h3').click(function(){
  $('#preview').append('<div><h3 id='+ '"h3_pre_' + h3_index +'"' + '>三级标题</h3></div>');
  $('#operation').append('<div><input type="text" id="h3_op_' + h3_index +'" placeholder="请输入三级标题" class="h3" data-id="'+ h3_index +'" data-mktype="h3" onchange="txt_change(this);"> <button class="btn btn-defalut" onclick="remove_item(this);" data-id="'+ h3_index +'" data-mktype="h3" id="h3_btn_' + h3_index +'">删除该节点</button></div>');
  h3_index += 1;
  });
  $('#btn_add_p').click(function(){
  $('#preview').append('<div><p id="p_pre_' + p_index +'">段落</p></div>');
  $('#operation').append('<div><input type="text" id="p_op_' + p_index +'" placeholder="请输入段落文字" data-id="'+ p_index +'" data-mktype="p" onchange="txt_change(this);"> <button class="btn btn-defalut" onclick="remove_item(this);" data-id="'+ p_index +'" data-mktype="p" id="p_btn_' + p_index +'">删除该节点</button></div>');
  p_index += 1;
  });
  $('#btn_add_img').click(function(){
  $('#preview').append('<div><img src="#" alt="图片" id="img_pre_'+ img_index +'"/></div>');
  $('#operation').append('<div><input type="text" id="img_op_'+ img_index +'" placeholder="请输入图片url" data-id="'+ img_index +'" data-mktype="img"><button class="btn btn-defalut" onclick="remove_item(this);" data-id="'+ img_index +'" data-mktype="img" id="img_btn_' + img_index +'">删除该节点</button></div>');
  img_index += 1;
  });
  remove_item = function(obj){
  type = $(obj).data('mktype');
  id = $(obj).data('id');
  $('#' + type + '_pre_' + id).remove();
  $('#' + type + '_op_' + id).remove();
  $('#' + type + '_btn_' + id).remove();
  };
  txt_change = function(obj){
  type = $(obj).data('mktype');
  id = $(obj).data('id');
  $('#'+type +'_pre_' + id).html($(obj).val());
  };
  var article_data = new Array();
  $('#btn_save').click(function(){
  $('#operation input').each(function(){
  type = $(this).data('mktype');
  var tmp_hash = new Object();
  tmp_hash["type"] = type;
  tmp_hash["content"] = $(this).val();
  article_data.push(tmp_hash);
  });
  $('#article_json').val(JSON.stringify(article_data));
  article_data = new Array();
  $('#btn_submit').removeClass('disabled');
  });
  //引入Plupload 、qiniu.js后
  var uploader = Qiniu.uploader({
  runtimes: 'html5,flash,html4',    //上传模式,依次退化
  browse_button: 'upload_img',       //上传选择的点选按钮，**必需**
  uptoken_url: '/article/token',            //Ajax请求upToken的Url，**强烈建议设置**（服务端提供）
  // uptoken : '', //若未指定uptoken_url,则必须指定 uptoken ,uptoken由其他程序生成
  // unique_names: true, // 默认 false，key为文件名。若开启该选项，SDK为自动生成上传成功后的key（文件名）。
  // save_key: true,   // 默认 false。若在服务端生成uptoken的上传策略中指定了 `sava_key`，则开启，SDK会忽略对key的处理
  domain: 'http://7xnj96.com1.z0.glb.clouddn.com',   //bucket 域名，下载资源时用到，**必需**
  container: 'preview',           //上传区域DOM ID，默认是browser_button的父元素，
  max_file_size: '100mb',           //最大文件体积限制
  flash_swf_url: 'js/plupload/Moxie.swf',  //引入flash,相对路径
  max_retries: 3,                   //上传失败最大重试次数
  dragdrop: true,                   //开启可拖曳上传
  drop_element: 'preview',        //拖曳上传区域元素的ID，拖曳文件或文件夹后可触发上传
  chunk_size: '4mb',                //分块上传时，每片的体积
  auto_start: true,                 //选择文件后自动上传，若关闭需要自己绑定事件触发上传
  init: {
  'FilesAdded': function(up, files) {
  plupload.each(files, function(file) {
  // 文件添加进队列后,处理相关的事情
  });
  },
  'BeforeUpload': function(up, file) {
  // 每个文件上传前,处理相关的事情
  },
  'UploadProgress': function(up, file) {
  // 每个文件上传时,处理相关的事情
  },
  'FileUploaded': function(up, file, info) {
  // 每个文件上传成功后,处理相关的事情
  // 其中 info 是文件上传成功后，服务端返回的json，形式如
  // {
  //    "hash": "Fh8xVqod2MQ1mocfI4S4KpRL6D98",
  //    "key": "gogopher.jpg"
  //  }
  // 参考http://developer.qiniu.com/docs/v6/api/overview/up/response/simple-response.html
  
  var domain = up.getOption('domain');
  var res = $.parseJSON(info);
  var sourceLink = domain + '/' + res.key; 
  $('#img_pre_' + (img_index - 1)).attr('src', sourceLink);
  $('#img_op_' + (img_index - 1)).val(sourceLink);
  },
  'Error': function(up, err, errTip) {
  //上传出错时,处理相关的事情
  alert(errTip);
  },
  'UploadComplete': function() {
  //队列文件处理完毕后,处理相关的事情
  },
  'Key': function(){
  var key = "article_#{@article.id}_img_" + (img_index - 1) + '.jpg';
  return key;
  }
  }
  });
  });
